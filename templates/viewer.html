<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Bus Tracker Viewer</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>

body{
margin:0;
font-family:Arial;
background:#0f172a;
color:white;
text-align:center;
}

#map{
height:80vh;
width:100%;
}

#info{
padding:10px;
background:#020617;
}

#status{
font-size:18px;
margin:5px;
color:#38bdf8;
}

#eta{
font-size:20px;
margin:5px;
color:#22c55e;
font-weight:bold;
}

</style>

</head>

<body>

<h2>ðŸšŒ Live Bus Tracker</h2>

<div id="info">

<div id="status">Finding your location...</div>

<div id="eta">ETA: --</div>

</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>

// map init
let map = L.map("map").setView([28.6139,77.2090],13);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{
maxZoom:19
}).addTo(map);


// bus icon
let busIcon = L.icon({
iconUrl:"https://cdn-icons-png.flaticon.com/512/61/61231.png",
iconSize:[32,32]
});


// user icon
let userIcon = L.icon({
iconUrl:"https://cdn-icons-png.flaticon.com/512/149/149071.png",
iconSize:[32,32]
});


let userMarker = null;

let markers = {};


// fun texts
let funTexts = [

"Scanning satellites... ðŸ›°ï¸",
"Locating buses... ðŸšŒ",
"Tracking in real-time... âš¡",
"Finding nearest bus... ðŸ“",
"Almost there... â³",
"Connected successfully âœ…"

];


// distance function
function getDistance(lat1, lon1, lat2, lon2){

let R = 6371;

let dLat = (lat2-lat1) * Math.PI/180;
let dLon = (lon2-lon1) * Math.PI/180;

let a =
Math.sin(dLat/2)*Math.sin(dLat/2) +
Math.cos(lat1*Math.PI/180) *
Math.cos(lat2*Math.PI/180) *
Math.sin(dLon/2)*Math.sin(dLon/2);

let c = 2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));

return R*c;

}



// show fun texts properly
let textIndex = 0;

setInterval(()=>{

document.getElementById("status").innerText =
funTexts[textIndex];

textIndex++;

if(textIndex >= funTexts.length)
textIndex = 0;

},2000);




// get user location
navigator.geolocation.watchPosition(pos=>{

let lat = pos.coords.latitude;
let lng = pos.coords.longitude;

if(userMarker){

userMarker.setLatLng([lat,lng]);

}
else{

userMarker = L.marker([lat,lng],{icon:userIcon})
.addTo(map)
.bindTooltip("You are here",{permanent:true});

map.setView([lat,lng],15);

}

});




// update buses
function updateBuses(){

fetch("/get_locations")

.then(res=>res.json())

.then(data=>{


// remove inactive markers
for(let b in markers){

if(!data[b]){

map.removeLayer(markers[b]);

delete markers[b];

}

}


// add or update markers
for(let b in data){

let lat = data[b].lat;
let lng = data[b].lng;

if(markers[b]){

markers[b].setLatLng([lat,lng]);

}
else{

markers[b] =
L.marker([lat,lng],{icon:busIcon})
.addTo(map)
.bindTooltip(b,{permanent:true});


// click event
markers[b].on("click", function(){

if(userMarker){

let user = userMarker.getLatLng();

let dist =
getDistance(
lat,
lng,
user.lat,
user.lng
);

let speed = 30; // km/h assumed

let eta =
(dist / speed) * 60;


document.getElementById("eta").innerText =
"ETA: " + eta.toFixed(1) + " minutes";


document.getElementById("status").innerText =
"Bus " + b +
" is " +
dist.toFixed(2) +
" km away";

}

});

}

}


});

}


// refresh every second
setInterval(updateBuses,1000);


</script>

</body>

</html>
