<!doctype html>
<html>
  <head>
    <title>Smart Bus Tracker</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

    <style>
      body {
        margin: 0;
        background: #070b1a;
        color: white;
        font-family: Arial;
      }

      #map {
        height: 75vh;
      }

      .info {
        padding: 15px;
      }
    </style>
  </head>

  <body>
    <h2 style="padding: 10px">üöå Smart Bus Tracker</h2>

    <div id="map"></div>

    <div class="info">
      <p id="speed">Speed: --</p>

      <p id="eta">ETA: --</p>

      <p id="message">Waiting...</p>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script>
      // INIT MAP

      let map = L.map("map");

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(
        map,
      );

      // CUSTOM ICONS FROM STATIC FOLDER

      let busIcon = L.icon({
        iconUrl: "/static/bus.png",
        iconSize: [60, 60],
      });

      let cafeIcon = L.icon({
        iconUrl: "/static/cafe.png",
        iconSize: [45, 45],
      });

      let stopIcon = L.icon({
        iconUrl: "/static/bus-stop.png",
        iconSize: [40, 40],
      });

      let userIcon = L.icon({
        iconUrl: "/static/user.png",
        iconSize: [35, 35],
      });

      // ADD CAFE MARKERS

      let godavery = L.marker([28.634277474648822, 77.06873700003767], {
        icon: cafeIcon,
      })
        .addTo(map)
        .bindPopup("<b>Godavery Bakery üç∞</b>");

      let fo = L.marker([28.67038310983833, 77.10965043578932], {
        icon: cafeIcon,
      })
        .addTo(map)
        .bindPopup("<b>FO Food Overloaded üçî</b>");

      // BUS STOPS

      let stops = [
        { name: "Godavery Stop", lat: 28.6345, lng: 77.069 },

        { name: "FO Stop", lat: 28.6705, lng: 77.1095 },

        { name: "Paschim Vihar Stop", lat: 28.666, lng: 77.095 },

        { name: "Janakpuri Stop", lat: 28.621, lng: 77.085 },
      ];

      stops.forEach((stop) => {
        L.marker([stop.lat, stop.lng], { icon: stopIcon })
          .addTo(map)
          .bindPopup("üöè " + stop.name);
      });

      // SHOW AREA INITIALLY

      map.fitBounds([
        [28.634277474648822, 77.06873700003767],
        [28.67038310983833, 77.10965043578932],
      ]);

      // VARIABLES

      let markers = {};

      let userMarker = null;

      let routeLine = null;

      let lastLat, lastLng, lastTime;

      let myBus = localStorage.getItem("bus") || "Bus";

      let sharing = localStorage.getItem("sharing") == "true";

      // DISTANCE CALCULATION

      function distance(lat1, lng1, lat2, lng2) {
        let R = 6371;

        let dLat = ((lat2 - lat1) * Math.PI) / 180;

        let dLng = ((lng2 - lng1) * Math.PI) / 180;

        let a =
          Math.sin(dLat / 2) ** 2 +
          Math.cos((lat1 * Math.PI) / 180) *
            Math.cos((lat2 * Math.PI) / 180) *
            Math.sin(dLng / 2) ** 2;

        let c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

        return R * c;
      }

      // FIND NEAREST STOP

      function nearestStop(lat, lng) {
        let min = 999;
        let nearest = null;

        stops.forEach((stop) => {
          let d = distance(lat, lng, stop.lat, stop.lng);

          if (d < min) {
            min = d;
            nearest = stop;
          }
        });

        return nearest;
      }

      // ETA USING FREE OSRM

      async function getETA(busLat, busLng, userLat, userLng) {
        let url =
          "https://router.project-osrm.org/route/v1/driving/" +
          busLng +
          "," +
          busLat +
          ";" +
          userLng +
          "," +
          userLat +
          "?overview=false";

        let res = await fetch(url);

        let data = await res.json();

        let seconds = data.routes[0].duration;

        return Math.round(seconds / 60);
      }

      // FUN MESSAGE

      function funMessage(speed) {
        if (speed < 5) return "Bus crawling üê¢";

        if (speed < 20) return "Bus chilling üöó";

        if (speed < 40) return "Bus cruising üòé";

        return "Driver beast mode üî•";
      }

      // TRACK USER LOCATION

      navigator.geolocation.watchPosition((pos) => {
        let lat = pos.coords.latitude;

        let lng = pos.coords.longitude;

        // USER MARKER

        if (!userMarker) {
          userMarker = L.marker([lat, lng], { icon: userIcon })
            .addTo(map)
            .bindPopup("You");
        } else {
          userMarker.setLatLng([lat, lng]);
        }

        // SHARE BUS

        if (sharing) {
          fetch("/update_location", {
            method: "POST",

            headers: {
              "Content-Type": "application/json",
            },

            body: JSON.stringify({
              lat: lat,
              lng: lng,
              bus: myBus,
            }),
          });
        }
      });

      // UPDATE BUS

      async function updateBus() {
        let res = await fetch("/get_locations");

        let data = await res.json();

        for (let bus in data) {
          let lat = data[bus].lat;

          let lng = data[bus].lng;

          // BUS MARKER

          if (!markers[bus]) {
            markers[bus] = L.marker([lat, lng], { icon: busIcon })
              .addTo(map)
              .bindTooltip(bus, { permanent: true });
          } else {
            markers[bus].setLatLng([lat, lng]);
          }

          // DRAW ROUTE

          let stop = nearestStop(lat, lng);

          if (routeLine) map.removeLayer(routeLine);

          routeLine = L.polyline(
            [
              [lat, lng],
              [stop.lat, stop.lng],
            ],
            { color: "cyan", weight: 4 },
          ).addTo(map);

          // SPEED

          if (lastLat) {
            let d = distance(lastLat, lastLng, lat, lng);

            let t = (Date.now() - lastTime) / 3600000;

            let speed = d / t;

            document.getElementById("speed").innerText =
              "Speed: " + speed.toFixed(1) + " km/h";

            document.getElementById("message").innerText = funMessage(speed);

            // ETA

            if (userMarker) {
              let user = userMarker.getLatLng();

              let eta = await getETA(lat, lng, user.lat, user.lng);

              document.getElementById("eta").innerText = "ETA: " + eta + " min";
            }
          }

          lastLat = lat;
          lastLng = lng;
          lastTime = Date.now();
        }
      }

      // REFRESH EVERY 2s

      setInterval(updateBus, 2000);
    </script>
  </body>
</html>
