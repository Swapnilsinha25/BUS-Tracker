<!doctype html>
<html>
  <head>
    <title>Bus Viewer</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

    <style>
      body {
        margin: 0;
        background: #070b1a;
        color: white;
        font-family: "Orbitron", sans-serif;
      }

      #map {
        height: 80vh;
      }

      button {
        padding: 12px 20px;

        border: none;
        border-radius: 10px;

        background: #00d4ff;

        color: white;

        margin: 10px;
      }
    </style>
  </head>

  <body>
    <h2 style="padding: 10px">ðŸ›° Bus Viewer</h2>

    <button id="stopBtn" onclick="stopSharing()" style="display: none">
      Stop Sharing
    </button>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script>
      let map = L.map("map").setView([28.6139, 77.209], 13);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(
        map,
      );

      let markers = {};

      if (localStorage.getItem("sharing") == "true")
        document.getElementById("stopBtn").style.display = "inline";

      function stopSharing() {
        localStorage.setItem("sharing", "false");

        alert("Stopped sharing");
      }

      function updateBuses() {
        fetch("/get_locations")
          .then((res) => res.json())
          .then((data) => {
            for (let bus in data) {
              let lat = data[bus].lat;
              let lng = data[bus].lng;

              if (markers[bus]) markers[bus].setLatLng([lat, lng]);
              else markers[bus] = L.marker([lat, lng]).addTo(map);
            }
          });
      }

      setInterval(updateBuses, 2000);
    </script>
  </body>
</html>
