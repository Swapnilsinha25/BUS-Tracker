<!DOCTYPE html>
<html>
<head>

<title>Bus Viewer</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet"
href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>

body{
margin:0;
background:#070b1a;
color:white;
font-family:Arial;
}

#map{
height:75vh;
}

.info{
padding:15px;
}

button{
padding:10px;
margin:10px;
border:none;
border-radius:8px;
background:#00d4ff;
color:white;
cursor:pointer;
}

</style>

</head>

<body>

<h2 style="padding:10px;">ðŸ›° Bus Viewer</h2>

<button id="stopBtn" onclick="stopSharing()" style="display:none;">
Stop Sharing
</button>

<div id="map"></div>

<div class="info">

<p id="speed">Speed: --</p>

<p id="message">Waiting for bus...</p>

</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>

// create map
let map = L.map('map').setView([28.6139,77.2090],13);

// load tiles
L.tileLayer(
'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'
).addTo(map);


// BUS ICON (big)
let busIcon = L.icon({
iconUrl:"/static/bus.png",
iconSize:[120,120]
});

// USER ICON
let userIcon = L.icon({
iconUrl:"https://cdn-icons-png.flaticon.com/512/149/149071.png",
iconSize:[40,40]
});


let markers = {};
let userMarker = null;

let lastLat, lastLng, lastTime;

let myBus = localStorage.getItem("bus") || "default";


// show stop button if sharing
if(localStorage.getItem("sharing")=="true"){

document.getElementById("stopBtn").style.display="inline";

startTracking();

}


// TRACK BUS SHARER GPS
function startTracking(){

navigator.geolocation.watchPosition(

function(pos){

fetch("/update_location",{

method:"POST",

headers:{
"Content-Type":"application/json"
},

body:JSON.stringify({

lat:pos.coords.latitude,
lng:pos.coords.longitude,
bus:myBus

})

});

},

function(err){
console.log(err);
},

{
enableHighAccuracy:true
}

);

}


// STOP SHARING
function stopSharing(){

localStorage.setItem("sharing","false");

window.location="/";

}


// SHOW USER LOCATION (viewer)
function showUserLocation(){

navigator.geolocation.getCurrentPosition(function(pos){

let lat = pos.coords.latitude;
let lng = pos.coords.longitude;

if(userMarker)
userMarker.setLatLng([lat,lng]);
else
userMarker = L.marker([lat,lng],{icon:userIcon})
.addTo(map)
.bindTooltip("You are here",{permanent:true});

});

}


// FUN SMART MESSAGES
function getBusMessage(speed){

if(speed<3)
return "Bus is crawling like turtle ðŸ¢";

if(speed<15)
return "Bus is chilling in traffic ðŸš—";

if(speed<40)
return "Bus is cruising smoothly ðŸ˜Ž";

if(speed<70)
return "Bus is zooming fast today âš¡";

return "Driver is in beast mode ðŸ”¥";

}


// DISTANCE CALC
function getDistance(lat1,lon1,lat2,lon2){

let R=6371;

let dLat=(lat2-lat1)*Math.PI/180;
let dLon=(lon2-lon1)*Math.PI/180;

let a=
Math.sin(dLat/2)**2+
Math.cos(lat1*Math.PI/180)*
Math.cos(lat2*Math.PI/180)*
Math.sin(dLon/2)**2;

let c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));

return R*c;

}


// UPDATE BUS MARKERS
function updateBuses(){

fetch("/get_locations")

.then(res=>res.json())

.then(data=>{

for(let b in data){

let lat=data[b].lat;
let lng=data[b].lng;


// create or update marker
if(markers[b])
markers[b].setLatLng([lat,lng]);
else{

markers[b]=L.marker([lat,lng],{icon:busIcon})
.addTo(map)
.bindTooltip(b,{permanent:true});

// auto focus on bus
map.setView([lat,lng],16);

}


// speed only for your bus
if(b===myBus){

let now=Date.now();

if(lastLat){

let dist=getDistance(lastLat,lastLng,lat,lng);

let timeDiff=(now-lastTime)/1000/3600;

let speed=dist/timeDiff;

document.getElementById("speed").innerText=
"Speed: "+speed.toFixed(1)+" km/h";

document.getElementById("message").innerText=
getBusMessage(speed);

}

lastLat=lat;
lastLng=lng;
lastTime=now;

}

}

});

}


// RUN EVERYTHING
showUserLocation();
setInterval(showUserLocation,5000);

updateBuses();
setInterval(updateBuses,2000);

</script>

</body>
</html>
