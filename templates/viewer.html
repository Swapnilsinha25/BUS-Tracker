<!DOCTYPE html>
<html>
<head>

<title>Bus Viewer</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet"
href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>

body{
margin:0;
background:#070b1a;
color:white;
font-family:Arial;
}

#map{
height:70vh;
}

.info{
padding:15px;
}

button{
padding:10px;
margin:10px;
border:none;
border-radius:8px;
background:#00d4ff;
color:white;
cursor:pointer;
}

</style>

</head>

<body>

<h2 style="padding:10px;">ðŸ›° Bus Viewer</h2>

<button id="stopBtn" onclick="stopSharing()" style="display:none;">
Stop Sharing
</button>

<div id="map"></div>

<div class="info">

<p id="speed">Speed: --</p>

<p id="message">Waiting for bus...</p>

</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>

let map = L.map('map').setView([28.6139,77.2090],13);

L.tileLayer(
'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'
).addTo(map);


// use your static bus.png
let busIcon = L.icon({
iconUrl:"/static/bus.png",
iconSize:[40,40]
});


let markers = {};

let lastLat, lastLng, lastTime;

let bus = localStorage.getItem("bus") || "default";


// show stop button if sharing
if(localStorage.getItem("sharing")=="true"){

document.getElementById("stopBtn").style.display="inline";

startTracking();

}


// THIS starts GPS from viewer page
function startTracking(){

navigator.geolocation.watchPosition(

function(pos){

fetch("/update_location",{

method:"POST",

headers:{
"Content-Type":"application/json"
},

body:JSON.stringify({

lat:pos.coords.latitude,
lng:pos.coords.longitude,
bus:bus

})

});

},

function(error){

console.log(error);

},

{
enableHighAccuracy:true
}

);

}


function stopSharing(){

localStorage.setItem("sharing","false");

window.location="/";

}


function getBusMessage(speed){

if(speed<5)
return "Bus is crawling like turtle ðŸ¢";

if(speed<20)
return "Bus is chilling in traffic ðŸš—";

if(speed<50)
return "Bus is zooming fast today âš¡";

return "Driver is in beast mode ðŸ”¥";

}


function getDistance(lat1,lon1,lat2,lon2){

let R=6371;

let dLat=(lat2-lat1)*Math.PI/180;
let dLon=(lon2-lon1)*Math.PI/180;

let a=
Math.sin(dLat/2)**2+
Math.cos(lat1*Math.PI/180)*
Math.cos(lat2*Math.PI/180)*
Math.sin(dLon/2)**2;

let c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));

return R*c;

}


// THIS fetches all buses and displays them
function updateBuses(){

fetch("/get_locations")

.then(res=>res.json())

.then(data=>{

for(let b in data){

let lat=data[b].lat;
let lng=data[b].lng;


if(markers[b])
markers[b].setLatLng([lat,lng]);

else
markers[b]=L.marker([lat,lng],{icon:busIcon}).addTo(map);


// calculate speed for YOUR bus
if(b===bus){

let now=Date.now();

if(lastLat){

let dist=getDistance(lastLat,lastLng,lat,lng);

let timeDiff=(now-lastTime)/1000/3600;

let speed=dist/timeDiff;

document.getElementById("speed").innerText=
"Speed: "+speed.toFixed(1)+" km/h";

document.getElementById("message").innerText=
getBusMessage(speed);

}

lastLat=lat;
lastLng=lng;
lastTime=now;

}

}

});

}


setInterval(updateBuses,2000);

</script>

</body>
</html>
